/*settings*{"name":"flappy_bird","author":"corax","image":[51,51,51,51,51,51,51,51,51,149,115,51,51,51,51,51,51,51,51,51,51,149,115,51,51,51,51,51,51,51,51,51,51,149,115,51,51,51,51,48,0,51,51,51,51,149,115,51,51,51,48,1,23,0,51,51,51,149,115,51,51,0,1,23,112,17,3,51,51,149,115,51,48,16,7,119,112,17,16,51,57,85,87,51,48,113,16,119,112,17,1,3,51,51,51,51,48,119,16,119,119,1,17,3,51,51,51,51,48,119,7,119,112,0,0,0,51,51,51,51,51,0,170,170,2,34,34,34,3,51,51,51,51,10,170,170,160,0,0,0,51,51,51,51,51,48,10,170,162,34,34,32,51,51,51,51,51,51,48,0,0,0,0,3,57,85,87,51,51,51,51,51,51,51,51,51,51,149,115,51,51,51,51,51,51,51,51,51,51,149,115,51]}*/
//16x12
char bird[] = {
    0x00, 0x00, 0x00, 0xbb, 0xbb, 0xb0, 0x00, 0x00, 0x00, 0x00, 0xbb, 0x11, 0xb1, 0x1b, 0x00, 0x00,
    0x00, 0x0b, 0x11, 0x7b, 0x11, 0x11, 0xb0, 0x00, 0x0b, 0xbb, 0x77, 0x7b, 0x11, 0x14, 0x1b, 0x00,
    0xb1, 0x11, 0xb7, 0x7b, 0x11, 0x14, 0x1b, 0x00, 0xb1, 0x11, 0x1b, 0x77, 0xb1, 0x11, 0x1b, 0x00,
    0xb7, 0x11, 0x7b, 0x77, 0x7b, 0xbb, 0xbb, 0xb0, 0x0b, 0x77, 0xb7, 0x77, 0xb2, 0x22, 0x22, 0x2b,
    0x00, 0xbb, 0xaa, 0xab, 0x2b, 0xbb, 0xbb, 0xb0, 0x00, 0xba, 0xaa, 0xaa, 0xb2, 0x22, 0x22, 0xb0,
    0x00, 0x0b, 0xba, 0xaa, 0xab, 0xbb, 0xbb, 0x00, 0x00, 0x00, 0x0b, 0xbb, 0xb0, 0x00, 0x00, 0x00
    };
//8x32
char tube[] = {
    0x95, 0xdd, 0xdd, 0x71, 0x95, 0xdd, 0xdd, 0x71,
    0x95, 0xdd, 0xdd, 0x71, 0x95, 0xdd, 0xdd, 0x71,
    0x95, 0xdd, 0xdd, 0x71, 0x95, 0xdd, 0xdd, 0x71,
    0x95, 0xdd, 0xdd, 0x71, 0x95, 0xdd, 0xdd, 0x71,
    0x95, 0xdd, 0xdd, 0x71, 0x95, 0xdd, 0xdd, 0x71,
    0x95, 0xdd, 0xdd, 0x71, 0x95, 0xdd, 0xdd, 0x71,
    0x95, 0xdd, 0xdd, 0x71, 0x95, 0xdd, 0xdd, 0x71,
    0x95, 0xdd, 0xdd, 0x71, 0x95, 0xdd, 0xdd, 0x71,
    0x95, 0xdd, 0xdd, 0x71, 0x95, 0xdd, 0xdd, 0x71,
    0x95, 0xdd, 0xdd, 0x71, 0x95, 0xdd, 0xdd, 0x71,
    0x95, 0xdd, 0xdd, 0x71, 0x95, 0xdd, 0xdd, 0x71,
    0x95, 0xdd, 0xdd, 0x71, 0x95, 0xdd, 0xdd, 0x71,
    0x95, 0xdd, 0xdd, 0x71, 0x95, 0xdd, 0xdd, 0x71,
    0x95, 0xdd, 0xdd, 0x71, 0x95, 0xdd, 0xdd, 0x71,
    0x95, 0xdd, 0xdd, 0x71, 0x95, 0xdd, 0xdd, 0x71,
    0x95, 0xdd, 0xdd, 0x71, 0x95, 0xdd, 0xdd, 0x71,
    0x95, 0xdd, 0xdd, 0x71, 0x95, 0xdd, 0xdd, 0x71,
    0x95, 0xdd, 0xdd, 0x71, 0x95, 0xdd, 0xdd, 0x71,
    0x95, 0xdd, 0xdd, 0x71, 0x95, 0xdd, 0xdd, 0x71,
    0x95, 0xdd, 0xdd, 0x71, 0x95, 0xdd, 0xdd, 0x71,
    0x95, 0xdd, 0xdd, 0x71, 0x95, 0xdd, 0xdd, 0x71,
    0x95, 0xdd, 0xdd, 0x71, 0x95, 0xdd, 0xdd, 0x71,
    0x95, 0xdd, 0xdd, 0x71, 0x95, 0xdd, 0xdd, 0x71,
    0x95, 0xdd, 0xdd, 0x71, 0x95, 0xdd, 0xdd, 0x71,
    0x95, 0xdd, 0xdd, 0x71, 0x95, 0xdd, 0xdd, 0x71,
    0x95, 0xdd, 0xdd, 0x71, 0x95, 0xdd, 0xdd, 0x71,
    0x95, 0xdd, 0xdd, 0x71, 0x95, 0xdd, 0xdd, 0x71,
    0x95, 0xdd, 0xdd, 0x71, 0x95, 0xdd, 0xdd, 0x71,
    0x95, 0xdd, 0xdd, 0x71, 0x95, 0xdd, 0xdd, 0x71,
    0x95, 0xdd, 0xdd, 0x71, 0x95, 0xdd, 0xdd, 0x71,
    0x95, 0xdd, 0xdd, 0x71, 0x95, 0xdd, 0xdd, 0x71,
    0x95, 0xdd, 0xdd, 0x71, 0x95, 0xdd, 0xdd, 0x71
    };
//16x16 rle
char fone[] = {
    0x0b, 0x33, 0x82, 0x11, 0x06, 0x33, 0x03, 0x11, 0x04, 0x33, 0x04, 0x11, 0x85, 0x13,
    0x11, 0x33, 0x31, 0x06, 0x11, 0x84, 0x13, 0x11, 0x1f, 0x03, 0xff, 0x04, 0x11, 0x82,
    0x1f, 0x02, 0x11, 0x82, 0x1f, 0x04, 0x11, 0x04, 0x1f, 0x04, 0x11, 0x82, 0x1f, 0x02,
    0x11, 0x83, 0x1f, 0xff, 0x02, 0x11, 0x85, 0x1f, 0xff, 0x1f, 0x99, 0x02, 0x1f, 0x02,
    0x11, 0x02, 0x1f, 0x85, 0x19, 0xdd, 0x9f, 0x1f, 0x02, 0x11, 0x92, 0x1f, 0x19, 0x9d,
    0xdd, 0xd9, 0x19, 0x99, 0x11, 0x1f, 0x9d, 0xdd, 0x9d, 0xd9, 0x9d, 0xdd, 0x91, 0x99,
    0x03, 0xdd, 0x82, 0x9d, 0x02, 0xdd, 0x82, 0xd9, 0x06, 0xdd, 0x82, 0x9d, 0x09, 0xdd
    };
char fone2[] = {
    0x08, 0x99, 0x8a, 0x55, 0x5d, 0xdd, 0xd5, 0x55, 0x5d, 0xdd, 0xd5, 0x55, 0x02, 0xdd,
    0x02, 0x55, 0x02, 0xdd, 0x8a, 0x55, 0x5d, 0xdd, 0xd5, 0x55, 0x5d, 0xdd, 0xd5, 0x55,
    0x02, 0xdd, 0x02, 0x55, 0x02, 0xdd, 0x02, 0x55, 0x08, 0xbb, 0x08, 0xcc, 0x48, 0x77
    };

char game, score, i, h;

void init();

void onexit() {
	if (spritegetvalue(1, S_Y) > 239)
		game = 0;
	else
		spritesetvalue(1, S_Y, 1);
}

void tubeOnexit(int n) {
	if(spritegetvalue(n, S_X) < 0 && game){
		spritesetvalue(n, S_X, 239);
		spritesetvalue(n, S_SPEEDX, 0 - speed);

		if (spritegetvalue(n, S_Y) < 120)
			spritesetvalue(n, S_HEIGHT, 24 + random(40));
		else {
			h = 24 + random(40);
			spritesetvalue(n, S_HEIGHT, h);
			spritesetvalue(n, S_Y, 224 - h);
			score++;
			speed = 6 + score;
			gotoxy(20,7);
			putn(score);
		}
	}
}

void oncollision() {
	game = 0;
	spritesetvalue(3, S_SPEEDY, 5);
}

void init() {
	game = 1;
	speed = 6;
	score = 0;
	setbgcolor(3);
	clearscreen();
	getsprite(1, bird);
	spritesetvalue(1, S_WIDTH, 16);
	spritesetvalue(1, S_HEIGHT, 12);
	spritesetvalue(1, S_SOLID, 1);
	spritesetvalue(1, S_GRAVITY, 3);
	spritesetvalue(1, S_SPEEDY, -1);
	spritesetvalue(1, S_SPEEDX, 0);
	spritesetvalue(1, S_ON_EXIT_SCREEN, onexit);
	spritesetvalue(1, S_ON_COLLISION, oncollision);
	putsprite(1, 5, 60);

	for (i = 0; i < 16; i++) {
		putimagerle(fone2, i * 16, 224, 16, 16);
		putimagerle(fone, i * 16, 208, 16, 16);
	}

	for(i = 2; i < 4; i++){
		getsprite(i, tube);
		spritesetvalue(i, S_WIDTH, 8);
		spritesetvalue(i, S_HEIGHT, 64);
		spritesetvalue(i, S_SPEEDX, -6);
		spritesetvalue(i, S_SPEEDY, 0);
		spritesetvalue(i, S_SOLID, 1);
		spritesetvalue(i, S_ON_EXIT_SCREEN, tubeOnexit);
	}

	putsprite(2, 240, 0);
	spritesetvalue(2, S_HEIGHT, 24 + random(40));
	putsprite(3, 240, 160);
}

void main() {
    while (1) {
        init();

        while (game) {
            spritesetvalue(1, S_ANGLE, spritegetvalue(1, S_SPEEDY));

            if (getkey())
                spritesetvalue(1, S_SPEEDY, -20);

            delayredraw();
        }

        for (i = 0; i < 20; i++)
            delayredraw();

        while (getkey() == 0) {
        }
    }
}